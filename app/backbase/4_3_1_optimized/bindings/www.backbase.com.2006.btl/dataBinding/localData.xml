<?xml version="1.0" encoding="UTF-8"?><d:tdl xmlns="http://www.w3.org/1999/xhtml" xmlns:b="http://www.backbase.com/2006/btl" xmlns:bb="http://www.backbase.com/2006/client" xmlns:d="http://www.backbase.com/2006/tdl"><d:namespace name="http://www.backbase.com/2006/btl"><d:uses interface="iDataCommunicator" src="dataBinding.xml"/><d:behavior name="localData" implements="b:iDataCommunicator"><d:resource type="text/javascript"><![CDATA[if(!btl.localData){btl.localData={};}btl.localData.performRequest=function btl_localData_performRequest(oDataSource,oRequestAction,oData,bJSON,oTypeHandler,oNode){switch(oRequestAction.type){case 'delete':return btl.localData.performDeleteRequest(oDataSource,oRequestAction,oData,bJSON,oTypeHandler);case 'update':return btl.localData.performUpdateRequest(oDataSource,oRequestAction);case 'create':return btl.localData.performCreateRequest(oDataSource,oRequestAction,oData,bJSON,oTypeHandler,oNode);case 'sort':case 'read':return btl.localData.performReadRequest(oDataSource,oRequestAction,oData,bJSON,oTypeHandler);}return null;};btl.localData.performCreateRequest=function btl_localData_performCreateRequest(oDataSource,oRequestAction,oData,bJSON,oTypeHandler,oNode){var aCreated={};var oIdField=btl.dataSource.getDataField(oDataSource,'identifier');var oNewRecord=oDataSource._._recordTemplate?oDataSource._._recordTemplate.getRecord():null;var saveData;if(bJSON){if(oData instanceof Array){saveData=function(oNewRec,sId){oData.push(oNewRec);};}else{if(oData instanceof Object){saveData=function(oNewRec,sId){oData[sId]=oNewRec;};}else{return {'records':aCreated};}}}else{if(oNode){if(!oNode.nodeType&&'length' in oNode){oNode=oNode[oNode.length-1].parentNode;}var oXMLTypeHandler=btl.dataSource.types.getType('application/xml');saveData=function(oNewRec,sId){oNode.appendChild(oNewRec);oDataSource._.oRecords.addRecord(new btl.dataBinding.Record(oNewRec,oXMLTypeHandler,sId,oIdField));};if(!oNewRecord){btl.dataBinding.fireErrorEvent(oDataSource,0,'No record template was provided to create a new record');return {'records':aCreated};}}else{return {'records':aCreated};}}function copyData(obj,data){if(data instanceof Object){for(var sItemName in data){if(data.hasOwnProperty(sItemName)){var oQuery=btl.dataSource.getDataField(oDataSource,sItemName);oTypeHandler.setValue(obj,oQuery,data[sItemName]);}}}}var bNoIdInRequest=oRequestAction.records instanceof Array;for(var sItemIndex in oRequestAction.records){var sRecId;var oNewRecord=oDataSource._._recordTemplate?oDataSource._._recordTemplate.getRecord():{};copyData(oNewRecord,oRequestAction.records[sItemIndex]);if(bNoIdInRequest){if(oIdField.select.length){sRecId=oTypeHandler.getValue(oNewRecord,oIdField);if(sRecId!=''&&sRecId!=null){if(oDataSource._.oRecords.hasRecord(sRecId)){btl.dataBinding.fireErrorEvent(oDataSource,0,'Record id - '+sRecId+' already exists');continue;}}else{sRecId=oDataSource._.oLocalData.sId+(oDataSource._.oLocalData.iLastId++);oTypeHandler.setValue(oNewRecord,oIdField,sRecId);}}else{sRecId=oDataSource._.oLocalData.sId+(oDataSource._.oLocalData.iLastId++);}}else{var bSaveId=false;if(oIdField.select.length){sRecId=oTypeHandler.getValue(oNewRecord,oIdField);if(sRecId==''||sRecId===null){bSaveId=true;sRecId=sItemIndex;}}else{sRecId=sItemIndex;}if(oDataSource._.oRecords.hasRecord(sRecId)){btl.dataBinding.fireErrorEvent(oDataSource,0,'Record id - '+sRecId+' already exists');continue;}if(bSaveId){oTypeHandler.setValue(oNewRecord,oIdField,sRecId);}}saveData(oNewRecord,sRecId);aCreated[sRecId]=oNewRecord;}var oRecords=new btl.dataBinding.RecordList();var oResponseAction=new btl.dataBinding.Action(oRequestAction.type,oRecords);oResponseAction.setAttribute('records',aCreated);return oResponseAction;};btl.localData.performReadRequest=function btl_localData_performReadRequest(oDataSource,oRequestAction,oData,bJSON,oTypeHandler){var oIdField=btl.dataSource.getDataField(oDataSource,'identifier');var oReadDelta=oTypeHandler.unserialize(oData,oIdField,oDataSource);var oReadDeltaAction=oReadDelta.getAction('read');var oRecords=oReadDeltaAction.records;var oResponseAction=new btl.dataBinding.Action(oRequestAction.type,oRecords);var aIndexes;var iTotalRecords;var bSelected=false,bSorted=false;if(oRequestAction.hasAttribute('records')){aIndexes=oRequestAction.getAttribute('records');}if(oRequestAction.hasAttribute('select')){if(oData){aIndexes=[];bSelected=true;var hSelect=oRequestAction.getAttribute('select');var aFilters=[];var aFields=[];var aRe=[];var aStr=[];var oRegexp=/^\/(.*)\/([gim]*)/;for(var sKey in hSelect){var sCondition=hSelect[sKey];var oFilter={};var aResult=oRegexp.exec(sCondition);oFilter.filter=aResult&&aResult.length?new RegExp(aResult[1],aResult[2]):sCondition;oFilter.field=btl.dataSource.getDataField(oDataSource,sKey,oRequestAction);aFilters.push(oFilter);}iTotalRecords=0;var aRecords=oRecords.getRecordList();for(var r=0,len=aRecords.length;r<len;r++){var oRecord=aRecords[r];var bMatch=true;for(var i=0,iMax=aFilters.length;i<iMax&&bMatch;i++){var oFilter=aFilters[i];var sValue=oRecord.getFieldValue(oFilter.field);bMatch=oFilter.filter instanceof RegExp?oFilter.filter.test(sValue):sValue==oFilter.filter;}if(bMatch){aIndexes[aIndexes.length]=oRecord.identifier;iTotalRecords++;}}}}if(oRequestAction.hasAttribute('sortDirection')&&oRequestAction.hasAttribute('sortField')){var sSortDir=oRequestAction.getAttribute('sortDirection');var oSortField=btl.dataSource.getDataField(oDataSource,oRequestAction.getAttribute('sortField'),oRequestAction);if(sSortDir&&sSortDir.length&&oSortField.name&&oSortField.name.length){var aArray=[];bSorted=true;if(aIndexes){for(var i=0,len=aIndexes.length;i<len;i++){aArray.push({'id':aIndexes[i],'value':oRecords.getRecord(aIndexes[i]).getFieldValue(oSortField)});}}else{var aRecords=oRecords.getRecordList();for(var i=0,len=aRecords.length;i<len;i++){var oRecord=aRecords[i];aArray.push({'id':oRecord.identifier,'value':oRecord.getFieldValue(oSortField)});}iTotalRecords=aArray.length;}var aResult=btl.dataBinding.sorters.sortObjectArray(aArray,oSortField.type,sSortDir=='descending');aIndexes=[];for(var i=0,len=aResult.length;i<len;i++){aIndexes[i]=aResult[i].id;}}}if(oRequestAction.hasAttribute('rangeStart')&&oRequestAction.hasAttribute('rangeEnd')){var iStart=oRequestAction.getAttribute('rangeStart');var iLast=oRequestAction.getAttribute('rangeEnd')+1;if(!aIndexes){aIndexes=[];var aRecords=oRecords.getRecordList();for(var i=iStart,len=Math.min(aRecords.length,iLast);i<len;i++){aIndexes.push(aRecords[i].identifier);}iTotalRecords=aRecords.length;}else{if(aIndexes){aIndexes=aIndexes.slice(iStart,iLast);}}}if(!isNaN(iTotalRecords)){oResponseAction.setAttribute('totalRecords',iTotalRecords);}if(aIndexes){oResponseAction.setAttribute('indexes',aIndexes);}return oResponseAction;};btl.localData.performUpdateRequest=function btl_localData_performUpdateRequest(oDataSource,oRequestAction){var aRecordIds=oRequestAction.records.getRecordIds();var oRecords=new btl.dataBinding.RecordList();var oResponseAction=new btl.dataBinding.Action(oRequestAction.type,oRecords);oResponseAction.setAttribute('records',aRecordIds);return oResponseAction;};btl.localData.performDeleteRequest=function btl_localData_performDeleteRequest(oDataSource,oRequestAction,oData,bJSON){var aRecordIds=oRequestAction.getAttribute('records');var aDeleted=[];if(bJSON&&oData instanceof Object){for(var i=0,iMax=aRecordIds.length;i<iMax;i++){delete oData[aRecordIds[i]];aDeleted[aDeleted.length]=aRecordIds[i];}}else{for(var i=0,iMax=aRecordIds.length;i<iMax;i++){if(oDataSource._.oRecords.hasRecord(aRecordIds[i])){var oCurNode=oDataSource._.oRecords.getRecord(aRecordIds[i]).source;var oParent=oCurNode.parentNode;if(oParent){oParent.removeChild(oCurNode);aDeleted[aDeleted.length]=aRecordIds[i];}}}}var oRecords=new btl.dataBinding.RecordList();var oResponseAction=new btl.dataBinding.Action(oRequestAction.type,oRecords);oResponseAction.setAttribute('records',aDeleted);return oResponseAction;};]]></d:resource><d:attribute name="dataSelect"/><d:attribute name="dataType" default="application/xml"><d:mapper type="text/javascript"><![CDATA[if(value in {'application/xml':true,'application/json':true,'text/xml':true,'text/json':true}){btl.dataBinding.setType(this,value);}else{bb.command.trace(this,'Data type: '+value+' is not supported.',3);}]]></d:mapper></d:attribute><d:attribute name="asynchronous" default="true"/><d:property name="dataRoot"><d:getter type="text/javascript"><![CDATA[if(this.hasAttribute('dataSelect')){var sDataSelect=this.getAttribute('dataSelect');var oData=bb.evaluateSmart(sDataSelect,this.modelNode,this.modelNode);}else{var sDataSelect='b:dataContainer/*';var oData=bb.evaluateSmart(sDataSelect,this.modelNode,function(sPrefix){return sPrefix=='b'?btl.namespaceURI:null;});}if(!oData){var sError='Data not found (result of "'+sDataSelect+'" )';btl.dataBinding.fireErrorEvent(this,0,sError);bb.command.trace(this,sError);return null;}return oData;]]></d:getter></d:property><d:method name="sendRequest"><d:argument name="action"/><d:argument name="observer"/><d:body type="text/javascript"><![CDATA[if(this.getAttribute('asynchronous')=='true'){var oThis=this;window.setTimeout(function(){if(oThis._){oThis.performRequest(action,observer);}},10);}else{this.performRequest(action,observer);}]]></d:body></d:method><d:method name="performRequest"><d:argument name="action"/><d:argument name="observer"/><d:body type="text/javascript"><![CDATA[var oData=this.getProperty('dataRoot');var sDataType=this.dataType;var oTypeHandler=btl.dataSource.types.getType(sDataType);if(!oData){btl.dataSource.requestQueueContinue(this);return;}var bJSON=this.dataType=='application/json'||this.dataType=='text/json';if(!bJSON){var oRootNode=oData.nodeType==9?oData.documentElement:oData;if(this.hasAttribute('recordSelect')){var oNode=bb.xml.selectNodes(oRootNode,this.getAttribute('recordSelect'),this.modelNode);var oNode=oNode.length&&oNode[oNode.length-1].parentNode||oRootNode;}else{var oNode=oRootNode;}}var oResponseActionGroup=new btl.dataBinding.ActionGroup();var oResponseAction=btl.localData.performRequest(this,action,oData,bJSON,oTypeHandler,oNode);if(oResponseAction){oResponseActionGroup.addAction(oResponseAction);}this.acceptData(oResponseActionGroup,observer);btl.dataSource.requestQueueContinue(this);]]></d:body></d:method><d:method name="pushData"><d:argument name="url"/><d:argument name="asynchronous"/><d:argument name="user"/><d:argument name="password"/><d:body type="text/javascript"><![CDATA[var oXHR=new XMLHttpRequest;var oSource=this;oXHR.onreadystatechange=function(){if(oXHR.readyState==4){var oEvent=bb.document.createEvent('Events');if(oXHR.status==0||(oXHR.status>=200&&oXHR.status<300)){oEvent.initEvent('dataResponse',true,false);oEvent.XMLHttpRequest=oXHR;oSource.dispatchEvent(oEvent);}else{oEvent.initEvent('error',true,false);oEvent.XMLHttpRequest=oXHR;oEvent.message=oXHR.statusText;oEvent.code=oXHR.status;oSource.dispatchEvent(oEvent);}}};oXHR.open('POST',url,asynchronous?true:false,user?user:'',password?password:'');oXHR.setRequestHeader('Accept','application/x-backbase+xml,application/xhtml+xml,application/xml,text/xml,*'+'/'+'*;q=0.5');var sData='';if(this.dataType=='application/xml'||this.dataType=='text/xml'){oXHR.setRequestHeader('Content-Type',this.dataType);var oData=this.getProperty('dataRoot');if(!oData.nodeType&&'length' in oData){sData=[];for(var i=0;i<oData.length;i++){sData.push(bb.xml.serialize(oData[i]));}sData='<data>'+sData.join('')+'</data>';}else{sData=bb.xml.serialize(oData);}}else{oXHR.setRequestHeader('Content-Type',this.dataType);sData=this.typeHandler.serialize(this.getProperty('dataRoot'));}oXHR.send(sData);]]></d:body></d:method><d:handler event="DOMNodeInsertedIntoDocument" type="text/javascript"><![CDATA[this._.oLocalData={sId:'rec_',iLastId:1};var oDataSchema;var aNodes=this.getProperty('childNodes');for(var i=0,iMax=aNodes.length;iMax>i;i++){if(bb.instanceOf(aNodes[i],btl.namespaceURI,'dataSchema')){oDataSchema=aNodes[i];break;}}if(oDataSchema){aNodes=oDataSchema.getProperty('childNodes');for(var i=0,iMax=aNodes.length;iMax>i;i++){if(bb.instanceOf(aNodes[i],btl.namespaceURI,'dataRecordTemplate')){this._._recordTemplate=aNodes[i];break;}}}]]></d:handler></d:behavior><d:element name="dataRecordTemplate"><d:method name="__children"><d:body type="text/javascript"/></d:method><d:method name="getRecord"><d:body type="text/javascript"><![CDATA[var oNode=bb.xml.selectSingleNode(this.modelNode,'*');if(oNode&&oNode.nodeType==1){return oNode.cloneNode(true);}else{return eval('('+this.getProperty('textContent')+')');}]]></d:body></d:method><d:constructor type="text/javascript"><![CDATA[try{this.getRecord();}catch(e){bb.command.trace(this,'Check the record template.',3);}]]></d:constructor></d:element></d:namespace></d:tdl>